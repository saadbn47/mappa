<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorateur Immobilier - Bordeaux M√©tropole</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }
        #header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #tabs {
            display: flex;
            justify-content: center;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            margin: 0 12px;
            background: white;
            border: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            color: #444;
        }
        .tab:hover, .active-tab {
            background: #1e3c72;
            color: white;
            transform: translateY(-2px);
        }
        .tab-content {
            display: none;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .active { display: block; }
        .container {
            display: flex;
            gap: 25px;
            margin-top: 20px;
        }
        #map {
            height: 500px;
            width: 65%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #stats-panel {
            width: 35%;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 200px;
            border: 1px solid #eee;
        }
        .search-container {
            text-align: center;
            margin: 30px 0;
        }
        .search-container input {
            padding: 12px 20px;
            width: 300px;
            border: 2px solid #eee;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .search-container input:focus {
            outline: none;
            border-color: #1e3c72;
        }
        .search-container button {
            padding: 12px 24px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            transition: background 0.3s ease;
        }
        .search-container button:hover {
            background: #2a5298;
        }
    </style>
</head>
<body>
    <div id="header">Explorateur de Donn√©es de l'Immobilier - Bordeaux M√©tropole</div>
    
    <div id="tabs">
        <div class="tab" onclick="showTab('carte')">üó∫Ô∏è Carte Interactive</div>
        <div class="tab active-tab" onclick="showTab('stats')">üìä Statistiques</div>
    </div>
    
    <div id="carte" class="tab-content">
        <h3>Carte Interactive</h3>
        <div class="container">
            <div id="map"></div>
            <div id="stats-panel">
                <h4>Donn√©es du quartier s√©lectionn√©</h4>
                <div id="selected-stats"></div>
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
    
    <div id="stats" class="tab-content active">
        <div class="search-container">
            <input type="text" id="iris_code" name="iris_code" placeholder="Entrer le code IRIS">
            <button onclick="handleSearch()">Rechercher</button>
        </div>
        <div class="stats-container">
            <div class="stat-box">
                <h4>Boxplots des Valeurs Fonci√®res</h4>
                <img id="boxplot-image" src="{{ url_for('static', filename='boxplots.png') }}" alt="Boxplots des Valeurs Fonci√®res">
            </div>
        </div>
        
    
    <script>
  // Replace the handleSearch function with:

  function handleSearch() {
    const irisCode = document.getElementById('iris_code').value;
    if (!irisCode) {
        alert('Veuillez entrer un code IRIS');
        return;
    }

    fetch('/generate_boxplot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `iris_code=${encodeURIComponent(irisCode)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add cache-busting parameter to force image refresh
            document.getElementById('boxplot-image').src = `/static/boxplots.png?t=${Date.now()}`;
        } else {
            alert('Erreur: ' + (data.error || 'Code IRIS non trouv√©'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Une erreur est survenue lors de la g√©n√©ration du boxplot');
    });
}

// Add event listener for Enter key
document.getElementById('iris_code').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        handleSearch();
    }
});
function showTab(tabId) { 
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active-tab'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active-tab');
            if (tabId === 'carte') {
                setTimeout(() => { map.invalidateSize(); }, 300);
            }
        }

        var map = L.map('map').setView([44.8378, -0.5792], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var markers = L.markerClusterGroup();

        fetch('/static/bordeaux_data.geojson')
            .then(response => response.json())
            .then(data => {
                console.log("GeoJSON Data Loaded:", data);
                data.features.forEach(feature => {
                    var marker = L.marker([feature.geometry.coordinates[1], feature.geometry.coordinates[0]]);
                    marker.bindTooltip(
                        `<b>Code IRIS:</b> ${feature.properties.code_iris}<br>
                        <b>Valeur fonci√®re/m¬≤:</b> ${feature.properties['valeur_fonciere/m¬≤']}‚Ç¨<br>
                        <b>Pr√©diction:</b> ${feature.properties.y_pred}‚Ç¨<br>
                        <b>Latitude:</b> ${feature.geometry.coordinates[1]}<br>
                        <b>Longitude:</b> ${feature.geometry.coordinates[0]}`,
                        { permanent: false, direction: "top" }
                    );
                    marker.on('click', function() {
                        document.getElementById('selected-stats').innerHTML = `<b>Code IRIS:</b> ${feature.properties.code_iris}<br>
                        <b>Valeur fonci√®re/m¬≤:</b> ${feature.properties['valeur_fonciere/m¬≤']}‚Ç¨<br>
                        <b>Pr√©diction:</b> ${feature.properties.y_pred}‚Ç¨<br>
                        <b>Latitude:</b> ${feature.geometry.coordinates[1]}<br>
                        <b>Longitude:</b> ${feature.geometry.coordinates[0]}`;
                    });
                    markers.addLayer(marker);
                });
                map.addLayer(markers);
            })
            .catch(error => {
                console.error("Error loading GeoJSON data:", error);
            });

        function updateChart(labels, data) {
            new Chart(document.getElementById('priceChart'), {
                type: 'line',
                data: { labels: labels, datasets: [{ label: '√âvolution des prix', data: data, borderColor: 'blue', fill: false }] },
            });
        }
    </script>
</body>
</html>